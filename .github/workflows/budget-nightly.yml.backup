name: Budget Nightly Automation

on:
  schedule:
    - cron: '30 12 * * *'  # 7:30 AM CT
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-accounts:
    runs-on: ubuntu-latest
    env:
      API_AUTH: ${{ secrets.API_AUTH }}
      API_REFRESH_URL: ${{ secrets.API_REFRESH_URL }}
    steps:
      - name: Check Secrets
        run: |
          if [ -z "$API_AUTH" ] || [ -z "$API_REFRESH_URL" ]; then
            echo "::error::API_AUTH or API_REFRESH_URL secret is not set"
            exit 1
          fi

      - name: Refresh Accounts
        run: |
          echo "Starting account refresh..."
          AUTH_HEADER=$(echo -n "$API_AUTH" | base64)
          RESPONSE=$(curl -i --location --request GET "$API_REFRESH_URL" \
          --header "Authorization: Basic $AUTH_HEADER")
          echo "Response: $RESPONSE"
        continue-on-error: true

  update-balance:
    needs: refresh-accounts
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Account Refresh
        run: |
          echo "Waiting 90 seconds for refresh to complete..."
          sleep 90

      - name: Update Balance
        id: update-balance
        run: |
          echo "Updating balance..."
          RESPONSE=$(curl -i --location --request POST 'https://qifbxpqtitmomvwfkvmx.supabase.co/functions/v1/chase-balance' \
          --header 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}')
          echo "Response: $RESPONSE"
        continue-on-error: true

  run-projections:
    needs: update-balance
    runs-on: ubuntu-latest
    steps:
      - name: Run Projections
        id: run-projections
        run: |
          echo "Running projections..."
          RESPONSE=$(curl -i --location --request POST 'https://qifbxpqtitmomvwfkvmx.supabase.co/functions/v1/budget-projection' \
          --header 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}')
          echo "Response: $RESPONSE"
        continue-on-error: true

  sync-calendar:
    needs: run-projections
    runs-on: ubuntu-latest
    steps:
      - name: Sync Calendar
        id: sync-calendar
        run: |
          echo "Syncing calendar..."
          RESPONSE=$(curl -i --location --request POST 'https://qifbxpqtitmomvwfkvmx.supabase.co/functions/v1/sync-calendar' \
          --header 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}')
          echo "Response: $RESPONSE"
        continue-on-error: true

  notify-failure:
    needs: [refresh-accounts, update-balance, run-projections, sync-calendar]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Alert
        run: |
          echo "Sending failure alert..."
          curl -i --location --request POST 'https://qifbxpqtitmomvwfkvmx.supabase.co/functions/v1/send-alert' \
          --header 'Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
          --header 'Content-Type: application/json' \
          --data '{
            "to": "${{ secrets.ALERT_EMAIL }}",
            "subject": "Budget Calendar: Nightly Job Failed",
            "text": "One or more steps in the nightly budget calendar job failed. Please check the GitHub Actions logs for details."
          }'
